//build: Tue Jul 05 2022 10:30:00 GMT+1100 (AUS Eastern Daylight Time): version 2.0.4: reinforce xSSFilter
//build: Tue Jun 07 2022 10:30:00 GMT+1100 (AUS Eastern Daylight Time): version 2.0.3: add xSSFilter for decodeURIComponent
//build: Thu Jun 02 2022 12:30:00 GMT+1100 (AUS Eastern Daylight Time): version 2.0.2: fix xss issue when show search title
//build: Mon Apr 16 2018 12:30:00 GMT+1100 (AUS Eastern Daylight Time): version 2.0.1: fix URL parameter replace function error and it will fix filter count issue
//build: Wed Jan 05 2018 15:46:00 GMT+1100 (AUS Eastern Daylight Time): remove . from qc nat suggest, e.g. 'nat 2345.'
//build: Mon Dec 05 2016 13:27:00 GMT+1100 (AUS Eastern Daylight Time): fix reset search term for do you mean
//build: Fri Dec 02 2016 13:27:00 GMT+1100 (AUS Eastern Daylight Time): use on instead click for event handler
//build: Mon Nov 25 2016 13:00:00 GMT+1100 (AUS Eastern Daylight Time): remove testing code
//build: Mon Nov 21 2016 15:00:00 GMT+1100 (AUS Eastern Daylight Time): Testing version
//build: Mon Nov 02 2016 15:30:00 GMT+1100 (AUS Eastern Daylight Time): enabled Faceted search(A/B Testing)
//build: Mon Oct 14 2016 14:30:00 GMT+1100 (AUS Eastern Daylight Time): fix issue of functions for hashcode change
//build: Mon Oct 04 2016 14:30:00 GMT+1100 (AUS Eastern Daylight Time): add functions for hashcode change
//build: Wed Jun 29 2016 10:22:00 GMT+1100 (AUS Eastern Daylight Time): rename namespace for ga functions
//build: Wed Jun 22 2016 13:10:00 GMT+1100 (AUS Eastern Daylight Time): enable google analytics
//build: Wed Mar 31 2016 16:45:00 GMT+1100 (AUS Eastern Daylight Time): fix date filter issue, date filter will be applied when do banner search
//build: Wed Mar 09 2016 16:45:00 GMT+1100 (AUS Eastern Daylight Time): store parameters in hash tag for banner search
//build: Fri Feb 12 2016 15:45:00 GMT+1100 (AUS Eastern Daylight Time): call setGSAFilter to set gsa filter flag
//build: Tue Feb 02 2016 15:27:00 GMT+1100 (AUS Eastern Daylight Time): fix UAR link issue
//build: Mon Jan 22 2016 12:57:00 GMT+1100 (AUS Eastern Daylight Time): no scrolling after searching 
//build: Mon Jan 11 2016 11:30:00 GMT+1100 (AUS Eastern Daylight Time): navigate to result page for QC search if only one result found and do not show result page in this case
//build: Wed Jan 09 2016 17:36:00 GMT+1100 (AUS Eastern Daylight Time): support calculators and tool search/Tax rates and codes search/print publication search
//build: Thu Jan 08 2016 17:00:00 GMT+1100 (AUS Eastern Daylight Time): navigate to result page for QC search if only one result found
//build: Thu Nov 10 2015 17:18:00 GMT+1100 (AUS Eastern Daylight Time): add gsa_suggest_div for mobile version
//build: Thu Nov 04 2015 17:21:00 GMT+1100 (AUS Eastern Daylight Time): trigger search when users select suggest items, it applies banner search and search page
//build: Thu Oct 28 2015 11:00:00 GMT+1100 (AUS Eastern Daylight Time): fix history back issue in firefox
//build: Thu Oct 23 2015 11:36:00 GMT+1100 (AUS Eastern Daylight Time): add gsa_suggest_div, bug fix
//build: Thu Oct 22 2015 16:26:00 GMT+1100 (AUS Eastern Daylight Time): add gsa_suggest_div
//build: Thu Oct 20 2015 13:15:00 GMT+1100 (AUS Eastern Daylight Time): hide description for UAR-suggest
//build: Thu Oct 19 2015 17:18:00 GMT+1100 (AUS Eastern Daylight Time): strip out page=x for NAT/QC search
//build: Thu Oct 06 2015 11:13:00 GMT+1100 (AUS Eastern Daylight Time): show UAR/suggest with new UI-bugfixing
//build: Thu Sep 05 2015 17:13:00 GMT+1100 (AUS Eastern Daylight Time): show UAR/suggest with new UI
//build: Wed Aug 05 2015 15:08:00 GMT+1100 (AUS Eastern Daylight Time): delay event handler binding for mobile popup/show 'Search for' by default for main search field
//build: Tue Aug 04 2015 17:50:00 GMT+1100 (AUS Eastern Daylight Time): enable suggest for mobile version/fix 'Search for ' issue for main search field
//build: Fri Jul 31 2015 13:01:00 GMT+1100 (AUS Eastern Daylight Time): Social medial content display with ATO html
//build: Thu Jul 30 2015 16:01:00 GMT+1100 (AUS Eastern Daylight Time): Social medial content display is ready
//build: Wed Jul 28 2015 11:40:00 GMT+1100 (AUS Eastern Daylight Time): Add Form Search/ACN/ABN Search
//build: Wed Jun 02 2015 11:03:00 GMT+1100 (AUS Eastern Daylight Time): 2-BR Allow Reserved Search Terms/Characters UI change;29-U Differentiate new and Updated Content
//build: Thu May 28 2015 16:09:00 GMT+1100 (AUS Eastern Daylight Time): Search result scroll to top bug fix
//build: Thu May 28 2015 14:11:00 GMT+1100 (AUS Eastern Daylight Time): L2 Fix only
//build: Wed May 27 2015 12:05:00 GMT+1100 (AUS Eastern Daylight Time):  change logic to fix 'repeat search for omitted result'
//build: Thu Apr 28 2015 17:30:00 GMT+1100 (AUS Eastern Daylight Time): remove filter for empty query to make sure no result return
//build: Thu Apr 27 2015 17:50:00 GMT+1100 (AUS Eastern Daylight Time): for QC/NAT search, avoid wrong empty q check message
//build: Thu Apr 23 2015 11:27:00 GMT+1100 (AUS Eastern Daylight Time): for QC/NAT search, only meta tag will be used, the search term will be set to empty
//build: Thu Apr 23 2015 15:48:00 GMT+1100 (AUS Eastern Daylight Time): show UAR with images in suggest list
//build: Thu Apr 21 2015 12:01:00 GMT+1100 (AUS Eastern Daylight Time): fixed suggest on banner search
//build: Thu Apr 20 2015 16:42:00 GMT+1100 (AUS Eastern Daylight Time): use querySuggest to replace old function to enable suggest function
//build: Thu Apr 16 2015 13:11:00 GMT+1100 (AUS Eastern Daylight Time): Set Cookie to capture search term for pop-up/feedback survey
//build: Thu Feb 12 2015 14:11:00 GMT+1100 (AUS Eastern Daylight Time): hide related search header if no cluster found
//build: Thu Feb 06 2015 17:44:05 GMT+1100 (AUS Eastern Daylight Time): fix 'Search for ' issue
//build: Thu Feb 06 2015 12:02:05 GMT+1100 (AUS Eastern Daylight Time): fixed twice error message issue
//build: Thu Feb 05 2015 17:02:05 GMT+1100 (AUS Eastern Daylight Time): support placeholder for IE
//build: Thu Feb 05 2015 15:26:05 GMT+1100 (AUS Eastern Daylight Time): show error message for empty banner search/add domain for event tracking
//build: Thu Feb 04 2015 16:50:05 GMT+1100 (AUS Eastern Daylight Time): change breadcrumbs/add advanced search
//build: Thu Feb 03 2015 17:56:05 GMT+1100 (AUS Eastern Daylight Time): change js function format/add error log for getParameterByNameInURL
//build: Thu Feb 03 2015 11:40:05 GMT+1100 (AUS Eastern Daylight Time): Fixed legal db search issue for banner search
//build: Thu Feb 02 2015 17:06:05 GMT+1100 (AUS Eastern Daylight Time): use placeholder for banner search/apply to current ATO site behaviour
//build: Thu Jan 29 2015 15:06:05 GMT+1100 (AUS Eastern Daylight Time): add event tracking for filter/date_filter/result click/recommendation click/quick link/cluster/pagin
//version 20150128-1500 fix suggest display issue on firefox and IE
//version 20150123-1600 encode url for event tracking/show top when clicks page navigation
//version 20150123-1000 change filter html structure/add spinning wheel
//version 20150122-1620 support EventTracking
 
/**
 * Define the namespace
 */
var ato = ato || {};
ato.spa = ato.spa || {};
ato.spa.version = "2.0.1";

//utility functions
ato.spa.util = ato.spa.util || {};
ato.spa.util.htmlDecodeEscapeSequence = function(value){
	 return value.replace(/\\x([0-9A-Fa-f]{2})/g, function() {
      return String.fromCharCode(parseInt(arguments[1], 16));
  });
};

ato.spa.util.preventDefault = function (evt){
	if(evt != null){
		if(evt.preventDefault){
			evt.preventDefault();
		}else{
			evt.returnValue = false;
		}
	}
};

ato.spa.util.endWith = function(inputStr, suffix){
	return inputStr.indexOf(suffix, inputStr.length - suffix.length) !== -1;
};

(function(){
	var GSA_LOCAL = false; // to deploy with proxy, please set it to false
	var SHOW_UAR_DESCRIPTION = false;
	var SHOW_ADVANCED_LINK = false; // show/hide adanced link
	//Search Request
	//GSA_BASE_URL = "https://www.ato.gov.au/GSAProxy/search?client=AtoGov_frontend&site=ATOGOV_Ektron&max_matches=10&use_similar=0";

	//Suggestion Request [token is search term]
	//GSA_BASE_URL = "https://www.ato.gov.au/GSAProxy/suggest?token=income&client=AtoGov_frontend&site=ATOGOV_Ektron&max_matches=10&use_similar=0";
	
	//Cluster request
	//GSA_BASE_URL = "https://www.ato.gov.au/GSAProxy/cluster?q=tax&client=AtoGov_frontend&site=ATOGOV_Ektron&max_matches=10&use_similar=0";
	//GSA_BASE_URL = "https://www.ato.gov.au/GSAProxy/cluster";
	
	//var GSA_DEFAULT_URL = GSA_BASE_URL + "&proxycustom=%3CHOME/%3E";
	var GSA_PAGE_CONTAINER = "results_container";
	var GSA_RESULT_LINK_CLASS = "gsa_result_link";
	var GSA_SEARCH_LINK_CLASS = "gsa_search_link";
	var GSA_UPDATE_SEARCH_LINK_CLASS = "gsa_update_search_link";
	var GSA_ADVANCE_SEARCH_LINK_CLASS = "gsa_advanced_link";
	var GSA_SUGGEST_DIV_ID = "gsa_suggest_div";
	var GSA_UAR_ITEM_LINK_CLASS = "gsa_uar_item_link";
	var GSA_UAR_ITEM_DESC_CLASS = "gsa_uar_desc";
	var GSA_UAR_HEAD_CLASS = "gsa_uar_head";
	var GSA_UAR_UL_CLASS = "gsa_uar_ul";
	var GSA_SUGGEST_ITEM_CLASS = "gsa_suggest_item";
	var GSA_SUGGEST_HEAD_CLASS = "gsa_suggest_head";
	
	//Top search box
	var GSA_TOP_SEARCH_FIELD_ID = "txt_banner_field";
	var GSA_TOP_SEARCH_MOBILE_BUTTON_CLASS = "btn-search";
	var GSA_TOP_SEARCH_BUTTON_CLASS = 'searchButton';
	var GSA_TOP_MS_CHK_ID = 'chk_banner_segment';
	var GSA_TOP_FORM_ID = 'aspnetForm';
	var GSA_TOP_ADVANCED_SEARCH_LINK_ID = 'search_linker';
	var GSA_BUTTON_CLASS = "gsa_search_button";
	var GSA_SEARCH_BUTTON_ID = "btnSearch0";
	var GSA_BUTTON_HOME = "btn_home";
	var GSA_BUTTON_TOP = "btn_std_top";
	var GSA_BUTTON_BOTTOM = "btn_std_bottom";
	var GSA_HASH_FLAG = "&gsa_hash=1";
	var GSA_HASH_LINK_ID = "gsa_spa_hash_link"; 
	var GSA_PROXYCUSTOM_HOME = "proxycustom=%3CHOME/%3E";
	
	//Cluster table
	var GSA_CLUSTER_TABLE1_ID = "ato_cluster_1";
	var GSA_CLUSTER_TABLE2_ID = "ato_cluster_2";
	var GSA_CLUSTER_title_ID = "ato_cluster_title";
	
	//Message box
	var GSA_MSG_DIV_ID = "gsa_spa_msg_div";
	
	
	//GSA configuration
	var GSA_SEARCH_SERVICE = "search";
	var GSA_CLUSTER_SERVICE = "cluster";
	var GSA_SUGGEST_SERVICE = "suggest";
	var GSA_SERVICES = {"search": GSA_SEARCH_SERVICE, "cluster": GSA_CLUSTER_SERVICE, "suggest" : GSA_SUGGEST_SERVICE};
	var GSA_PORXY_PROTOCAL = "http";
	var GSA_PORXY_DOMAIN = "/GSAProxy";// for ATO: /GSAProxy
	if(GSA_LOCAL){
		GSA_PORXY_DOMAIN = "";//GSA Test Server IP here.
	}
	var GSA_PROXY = {"protocol": GSA_PORXY_PROTOCAL, "domain" : GSA_PORXY_DOMAIN};
	
	var GSA_P_COLLECTION = ato.spa.config.getDefaultSite(); 
	var GSA_P_FRONTEND = ato.spa.config.getDefaultFrontend();
	var GSA_P_CLIENT = ato.spa.config.getDefaultClient();
	var GSA_P_OUTPUT = "xml_no_dtd";
	var GSA_REQIRUED = ato.spa.config.getConfigValue('gsa_searchable'); // -- confirm with ATO about the default value 
	var GSA_REQUEST_PARAMS = {"site":GSA_P_COLLECTION, "client" : GSA_P_CLIENT, "proxystylesheet" : GSA_P_FRONTEND, "output":GSA_P_OUTPUT, "requiredfields":GSA_REQIRUED};
	
	ato.spa.gsa = ato.spa.gsa || {};
	ato.spa.gsa.services = GSA_SERVICES;
	ato.spa.gsa.proxy = GSA_PROXY;
	ato.spa.gsa.requestParams = GSA_REQUEST_PARAMS;
	
	ato.spa.gsa.debug = false; //Please set it to false when release!!!. if true, partialfields and requiredfields will be removed from the gsa search request.
	ato.spa.gsa.useRequiredFieldsForFilter = false;//if true, then use requiredfields, otherwise, use partial fields.
	
	var GSA_CONTAINER_POSITION = 0;
	var GSA_KEYMATCH_SUFFIX_REC = "#REC";
	var GSA_KEYMATCH_SUFFIX_QLK = "#QLK";
	var GSA_KEYMATCH_SUFFIX_TOD = "#TOD";
	
	var GSA_CUSTOM_POST_ACTION = new Array();
	
	function _compitableIE8(){
		if (typeof String.prototype.trim !== 'function') {
			String.prototype.trim = function() {
				return this.replace(/^\s+|\s+$/g, '');
			}
		}
		

		if (!Object.keys) {
			Object.keys = function(obj) {
				var keys = [];

				for ( var i in obj) {
					if (obj.hasOwnProperty(i)) {
						keys.push(i);
					}
				}

				return keys;
			};
		}
	}
	_compitableIE8();
	
	function querySuggest(request, response){
		ato.spa.GSAManager.querySuggest(request, response, ato.spa.GSAManager);
	}
	
	/**
	 * get the parameter value in the current location 
	 */
	ato.spa.gsa.getParameterByName = function(name, url) {
		if(url == undefined || url == null || url == ''){
			url = location.search;
		}
	    return ato.spa.gsa.getParameterByNameInURL(name, url);
	};
	
	ato.spa.gsa.getParameterByNameInURL = function(name, url) {
	    name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
	    var regex = new RegExp("[\\?&]" + name + "=([^&#]*)");
	    results = regex.exec(url);
	    try{
	    	return results === null ? "" : xSSFilter(decodeURIComponent(xSSFilter(results[1].replace(/\+/g, " "))));
	    }catch(e){
	    	console.log(e);
	    	return "";
	    }
	    
	};
	
	function xSSFilter(str){
		return str.replace(/(<([^>]+)>)/gi, '').replace(/&/g, '').replace(/"/g, '').replace(/'/g, '').replace(/</g, '').replace(/>/g, '');
	}
	
	ato.spa.gsa.replaceParamInURL = function(url, paramName, newValue){
		//if url does not start with '&', append one '&'
		var startsWithAnd = url.indexOf("&") == 0;
		if(!startsWithAnd){
			url = "&" +  url;
		}
		var startPosition = url.indexOf("&" + paramName +"=");
		var value = newValue;
		var result = url;
		if(startPosition >= 0){//found old value
			result =  url.substr(0, startPosition) + "&" + paramName +"=" + value;
			var endPostion = url.indexOf("&", startPosition + ("&" + paramName +"=").length);
			if(endPostion > 0){//no "&"
				result += url.substr(endPostion);
			}
		}else{
			result += "&" + paramName +"=" + value;
		}
		if(!startsWithAnd){
			return result.substr(1);
		}else{
			return result;
		}
		
	};
	
	ato.spa.gsa.cleanHashValue = function(hashValue){
		if(hashValue == null){
			return hashValue;
		}else{
			var endPosition = hashValue.indexOf("/");
			if(endPosition < 0){
				return hashValue;
			}else{
				return hashValue.substr(0,endPosition );
			}
		}
	};
	
	ato.spa.gsa.loadjscssfile = function(filename, filetype){
	    if (filetype=="js"){ //if filename is a external JavaScript file
	        var fileref=document.createElement('script');
	        fileref.setAttribute("type","text/javascript");
	        fileref.setAttribute("src", filename);
	    }
	    else if (filetype=="css"){ //if filename is an external CSS file
	        var fileref=document.createElement("link");
	        fileref.setAttribute("rel", "stylesheet");
	        fileref.setAttribute("type", "text/css");
	        fileref.setAttribute("href", filename);
	    }
	    if (typeof fileref!="undefined"){
	    	document.getElementsByTagName("head")[0].appendChild(fileref);
	    }
	        
	};
	
	ato.spa.gsa.trimWebappSuffix = function(url){
		var result = url;
		if(ato.spa.util.endWith(url, GSA_KEYMATCH_SUFFIX_REC)){
			url = url.substring(0, url.length - GSA_KEYMATCH_SUFFIX_REC.length);
		}
		if(ato.spa.util.endWith(url, GSA_KEYMATCH_SUFFIX_QLK)){
			url = url.substring(0, url.length - GSA_KEYMATCH_SUFFIX_QLK.length);
		}
		if(ato.spa.util.endWith(url, GSA_KEYMATCH_SUFFIX_TOD)){
			url = url.substring(0, url.length - GSA_KEYMATCH_SUFFIX_TOD.length);
		}
		return url;
	};
	
	var Base64 = {_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(e){var t="";var n,r,i,s,o,u,a;var f=0;e=Base64._utf8_encode(e);while(f<e.length){n=e.charCodeAt(f++);r=e.charCodeAt(f++);i=e.charCodeAt(f++);s=n>>2;o=(n&3)<<4|r>>4;u=(r&15)<<2|i>>6;a=i&63;if(isNaN(r)){u=a=64}else if(isNaN(i)){a=64}t=t+this._keyStr.charAt(s)+this._keyStr.charAt(o)+this._keyStr.charAt(u)+this._keyStr.charAt(a)}return t},decode:function(e){var t="";var n,r,i;var s,o,u,a;var f=0;e=e.replace(/[^A-Za-z0-9\+\/\=]/g,"");while(f<e.length){s=this._keyStr.indexOf(e.charAt(f++));o=this._keyStr.indexOf(e.charAt(f++));u=this._keyStr.indexOf(e.charAt(f++));a=this._keyStr.indexOf(e.charAt(f++));n=s<<2|o>>4;r=(o&15)<<4|u>>2;i=(u&3)<<6|a;t=t+String.fromCharCode(n);if(u!=64){t=t+String.fromCharCode(r)}if(a!=64){t=t+String.fromCharCode(i)}}t=Base64._utf8_decode(t);return t},_utf8_encode:function(e){e=e.replace(/\r\n/g,"\n");var t="";for(var n=0;n<e.length;n++){var r=e.charCodeAt(n);if(r<128){t+=String.fromCharCode(r)}else if(r>127&&r<2048){t+=String.fromCharCode(r>>6|192);t+=String.fromCharCode(r&63|128)}else{t+=String.fromCharCode(r>>12|224);t+=String.fromCharCode(r>>6&63|128);t+=String.fromCharCode(r&63|128)}}return t},_utf8_decode:function(e){var t="";var n=0;var r=c1=c2=0;while(n<e.length){r=e.charCodeAt(n);if(r<128){t+=String.fromCharCode(r);n++}else if(r>191&&r<224){c2=e.charCodeAt(n+1);t+=String.fromCharCode((r&31)<<6|c2&63);n+=2}else{c2=e.charCodeAt(n+1);c3=e.charCodeAt(n+2);t+=String.fromCharCode((r&15)<<12|(c2&63)<<6|c3&63);n+=3}}return t}};
	
	ato.spa.gsa.Base64 = Base64;
	
	function GSAManager(){
		this.requestParams = ato.spa.gsa.requestParams;
		this.doingSearch = false;
		this.loadingHistory = false;
		
		this.qResetNeeded = true;
		this._eventType = ''; //for event tracking
		
		this.getSite = function(url){
			var siteInURL = ato.spa.gsa.getParameterByName('site',url);
			if(siteInURL == ''){
				//return this.requestParams.site;
				return ato.spa.config.getDefaultSite();
			}else{
				return siteInURL;
			}
		};
		this.htmlEncode = function(value){
			if(encodeURIComponent){
				return encodeURIComponent(value);
			}else if(encodeURI){
				return encodeURI(value);
			}else{
				return escape(value);
			}
		};
		
		this._getDefaultRequestParams = function(url){
			var site = this.getSite(url);
			if(site == null || site == ''){
				site = GSA_P_COLLECTION;
			}
			var result = "site=" + site + "&" + this.getOutputParams() ;
			if(ato.spa.gsa.debug){//For debug
				//do nothing-do not append required/partial
			}else{
				var requiredfields =  ato.spa.gsa.getParameterByName('requiredfields', url);
				if(requiredfields == ''){
					requiredfields = this.requestParams.requiredfields;
				}
				result += "&requiredfields=" + requiredfields;
				
				var partialfields = ato.spa.gsa.getParameterByName('partialfields',url);
				if(partialfields != ''){
					result += "&partialfields=" + partialfields;
				}
			}
			return result;
		};
		this.getOutputParams = function(){
			var result = "client=" + this.requestParams.client 
			+ "&proxystylesheet=" + this.requestParams.proxystylesheet + "&output=" + this.requestParams.output;
			return result;
		}
		this._getDefaultSearchURL = function(url){
			var result = this._getSearchService();
			var requestParam = this._getDefaultRequestParams(url);
			result += "?" + requestParam;
			
			var q = ato.spa.gsa.getParameterByName('q',url);
			if(q != ''){
				result += '&q=' + this.htmlEncode(q);
			}else{
				result += '&q=';
			}
			var proxycustom = ato.spa.gsa.getParameterByName('proxycustom',url);
			if(proxycustom != '' && proxycustom.indexOf('ADVANCED') > 0){ //only for advanced search
				result +="&proxycustom=" + proxycustom;
			}
			//append global parameters
			result += "&" + ato.spa.search.buildGlobalParamsForURL(q,result);
			return result;
		};
		
		this._getSearchService = function(){
			//var result = ato.spa.gsa.proxy.protocol + "://" + ato.spa.gsa.proxy.domain + "/" + ato.spa.gsa.services.search;
			var result =  ato.spa.gsa.proxy.domain + "/" + ato.spa.gsa.services.search;
			return result;
		};
		
		this._getClusterURL = function(){
			//var result = ato.spa.gsa.proxy.protocol + "://" + ato.spa.gsa.proxy.domain + "/" + ato.spa.gsa.services.cluster;
			var result =  ato.spa.gsa.proxy.domain + "/" + ato.spa.gsa.services.cluster;
			return result;
		};
		
		this._getSuggestURL = function(){
			//var result = ato.spa.gsa.proxy.protocol + "://" + ato.spa.gsa.proxy.domain + "/" + ato.spa.gsa.services.suggest;
			var result =  ato.spa.gsa.proxy.domain + "/" + ato.spa.gsa.services.suggest;
			return result;
		};
		
		this.showErrorMsg = function(msg, type){
			//use jQuery dialog
//			if($('#' +  GSA_MSG_DIV_ID).length == 0){
//				$(body).append('<div id="' + GSA_MSG_DIV_ID + '" style="display:none" title="Message"/>');
//			}
//			$('#' +  GSA_MSG_DIV_ID).text(msg);
//			$('#' +  GSA_MSG_DIV_ID).dialog({
//				modal: true,
//				dialogClass: "no-close",
//				buttons: [
//				    {
//				      text: "OK",
//				      click: function() {
//				        $( this ).dialog( "close" );
//				      }
//				    }
//				  ]
//			});
			alert(msg);
		};
		
		this.clearMsg = function(){
        	$('#' +  GSA_MSG_DIV_ID).dialog("close");
		};
		
		this.getContainer =  function(){
			return $("#" + GSA_PAGE_CONTAINER);
		};
		this.setScrollPosition = function(){
			GSA_CONTAINER_POSITION = document.body.scrollTop;
		};
		this.setBackScrollPosition = function(){
			window.scrollTo(0,GSA_CONTAINER_POSITION);
		};
		
		//it will process: search/filter/data filter/page navigation/cluster
		this._trackSearchEvernt = function(){
			var currentEventType = this.getEventType();
			var searchEventType = ato.spa.config.getConfigValue("ato_search_event_search");
			if(currentEventType == ''){
				currentEventType = searchEventType;//default for search
			}
//			if(searchEventType == currentEventType){
			var count = $("#ato_search_result_count").text().trim();
			if(count == ''){
				count = '0';
			}
			var url = ato.spa.search.getLastSearchURL();
			//get full path
			url = window.location.protocol + "//" + window.location.hostname + this._getSearchService() + "?" + url;
			
			var searchURL =  this.htmlEncode(url);
			var countName = ato.spa.config.getConfigValue("ato_search_event_p_tsv");
			var q = this._getQ(0);
			var trackData = "ev=" + currentEventType + "&lc="+searchURL + "&" + countName + "=" + count + "&q=" + q;
			//for page navigation
			if(currentEventType == ato.spa.config.getConfigValue("ato_search_event_paging")){
				var startIndex = $($('.resultsList')[0]).attr('start');
				var pageNum = (parseInt(startIndex) -1) / 10 + 1;
				trackData += "&page=" + pageNum;
			}
			this.trackEvent(trackData);
			
			
//			}
		};
		
		this._isAdvancedSearch = function(){
			try{
				return $('input[name="as_q"').length > 0;
			}catch(e){
				return  false;
			}
		};
		
		this.registerPostAction = function (func){
			if($.inArray(func, GSA_CUSTOM_POST_ACTION) < 0){
				GSA_CUSTOM_POST_ACTION.push(func);
			}
		};
		
		this._callRegisteredPostActions = function(){
			for(var i = 0; i < GSA_CUSTOM_POST_ACTION.length; i++){
				GSA_CUSTOM_POST_ACTION[i]();
			}
		};
		
		this._showContent = function(data,context){
			var showResultPage = true;
			ato.spa.search.stopHourGlass();
			$("#" + GSA_PAGE_CONTAINER).hide();
			try{
				
				if($("#" + GSA_PAGE_CONTAINER).length > 0){
					if(window.jq1102 != null && window.jq1102 != undefined){
						jq1102("#" + GSA_PAGE_CONTAINER).html(data);
					}else{
						$("#" + GSA_PAGE_CONTAINER).html(data);
					}
					
				}
			}catch(e){
				//even there is any html error, let the program run.
				//console.log(e);
			}
			//update UI,like suggest list
			context.UIUpdate();
			//always show top
			context.setBackScrollPosition();
			//window.scrollTo(0,GSA_CONTAINER_POSITION); //x, y
			
			//$('body').animate({scrollTop: top}, 0);  // not working for Chrome.
			
			if(context._isAdvancedSearch()){//advanced page
				context._updateFormSubmit(context);
			}else{ // normal search page
				//upate query
				if(context.qResetNeeded){
					ato.spa.search.resetQuery();
				}else{
					ato.spa.search.resetQueryForQC();
					context.qResetNeeded = true;
				}
				
				context._initMainSearchBoxPlaceholder(context);
				//track event
				context._trackSearchEvernt();
				
				context._callRegisteredPostActions();
				//initFilter
				ato.spa.search.initFilter();
//				context._updateSubmitButton(context);
				context._updateSearchLink(context);
				context._updateAdvancedLink(context);
				context._initSuggest(context);
				context._updateResultLink(context);
				context.getCluster();
				
				ato.spa.search.updateBreadcrumbs();
				ato.spa.search.formatDefition();
				ato.spa.search.formatRecommendation();
				ato.spa.search.formatSummary();
				//ato.spa.search.upadteFormSearchUI();
				//ato.spa.search.upadteABNACNSearchUI();
				ato.spa.search.formatVideoResult();
				ato.spa.search.updateResultLink();
				//29-U Differentiate new and Updated Content
				ato.spa.search.updateDateTip();
				
				if(SHOW_ADVANCED_LINK){
					var obj = $('#' + GSA_SEARCH_BUTTON_ID);
					context._showAdvanceLink(obj);
				}
				showResultPage = ato.spa.search.postAction();
				context._handleErrorMessage();
			}
			if(showResultPage){
				$("#" + GSA_PAGE_CONTAINER).show();
				context.setBackScrollPosition();
			}
			
		};
		
		this.submitForm = function(q){
			var url = this._getDefaultSearchURL();
			var requestURL = url + "&q=" + this.htmlEncode(q);
			//ga tracking
			if(ato.spa.gsa.ga){
				ato.spa.gsa.ga.triggerInitialSearch(q);
			}
			this._ajaxCall(requestURL);
		};
		
		this._getQ = function(index){
			return ato.spa.search.formatQ(document.forms[index].q.value);
		}
		
		this._setQ = function(value){
			document.forms[0].q.value = value
		};
		
		this._updateFormSubmit = function(context){
			var size = document.forms.length;
			for(var i = 0; i < size; i++){
				$(document.forms[i]).submit(function( event ) {
					ato.spa.util.preventDefault(event);
					var urlParams =  $(this).serialize();
					//ga tracking
					var q = ato.spa.gsa.getParameterByNameInURL("q", "?" + urlParams);
					if(ato.spa.gsa.ga){
						ato.spa.gsa.ga.triggerInitialSearch(q);
					}
					context.doSearch(urlParams);
				});
			}
		};
		
		this._updateSubmitButton = function(context){
			$("." + GSA_BUTTON_CLASS).each(function(){
				$(this).click(function(){
					var id = $(this).attr("id");
					var q = '';
					if(id == GSA_BUTTON_HOME || id == GSA_BUTTON_TOP){
						q = context._getQ(0);
					}else{
						q = context._getQ(1);
					}
					if(q != ''){
						this.submitForm(q);
					}
				});
			});
		};
		
		//add event tracking for result click and keymatch/quicklink
		this._updateResultLink = function(context){
			var searchTerm = context._getQ(0);
			//----------------------
			var cookiename = "ATOGov_SearchTermCookie";
			var exmins = 1; // equalent to 1 min
			
			setCookie(cookiename, searchTerm, exmins);
			//---------------------
			$("a").each(function(){
				//
				var linkObj = $(this);
				var ctype = linkObj.attr("ctype");
				if(ctype == 'c'){//result click
					var eventType = ato.spa.config.getConfigValue('ato_search_event_result_click');
					var startRank = $($('.resultsList')[0]).attr('start');
					if(startRank == null || startRank == ''){
						startRank = 1;
					}else{
						startRank = parseInt(startRank);
					}
					var rank = parseInt(linkObj.attr("rank")) +  startRank - 1;
					var data = "ev=" + eventType + "&rank=" + rank + "&q=" + searchTerm;
					linkObj.click(function(){
						context.trackEvent(data);
						
					});
					
				}else if(ctype == 'keymatch'){
					var eventType = ato.spa.config.getConfigValue('ato_search_event_recommendation');
					var data = "ev=" + eventType + "&q=" + searchTerm;
					linkObj.click(function(){
						context.trackEvent(data);
						
					});
				}else if(ctype == 'qlk'){
					var eventType = ato.spa.config.getConfigValue('ato_search_event_quicklink');
					var data = "ev=" + eventType + "&q=" + searchTerm;
					linkObj.click(function(){
						context.trackEvent(data);
						
					});
				}
			});
		};
		
		this._updateSearchLink = function(context){
			$("." + GSA_SEARCH_LINK_CLASS).each(function(){
				context.updateSearchLink(context,this);
			});
		};
		
		this.updateSearchLink = function(context, linkObj){
			var ctypeTT = $(linkObj).attr("ctype");
			//ING
//			if(ctypeTT == 'sitesearch'){
//				$(linkObj).on('click',function(e){
//					ato.spa.util.preventDefault(e);
//					console.log("More result");
//				});
//			}else{
			//TESTING code
			var ctypeTest = $(linkObj).attr("ctype");
			var urlTest = $(linkObj).attr("href");
			console.log("ctype=" + ctypeTest + "; url=" + urlTest);
			$(linkObj).on('click',function(event){
				ato.spa.util.preventDefault(event);
				//event tracking
				var ctype = $(linkObj).attr("ctype");
				if(ctype == 'nav'){
					var eventType = ato.spa.config.getConfigValue('ato_search_event_paging');
					context.setEventType(eventType);
					context.qResetNeeded = true;
				}else if(ctype == 'spell'){
					//ING
					context.qResetNeeded = false;
				}else{
					context.qResetNeeded = true;
				}
				var url = $(linkObj).attr("href");
				context._ajaxCallSearch(url);
				return false;
			});
			
//			$(linkObj).click(function(event){
//				ato.spa.util.preventDefault(event);
//				//event tracking
//				var ctype = $(linkObj).attr("ctype");
//				if(ctype == 'nav'){
//					var eventType = ato.spa.config.getConfigValue('ato_search_event_paging');
//					context.setEventType(eventType);
//				}
//				var url = $(linkObj).attr("href");
//				context._ajaxCallSearch(url);
//				return false;
//			});
//			}
			
		};
		
		this._updateAdvancedLink = function(context){
			$("." + GSA_ADVANCE_SEARCH_LINK_CLASS).each(function(){
				$(this).click(function(event){
					ato.spa.util.preventDefault(event);
					
					var url = $(this).attr("href");
					context._ajaxCallSearch(url);
					return false;
				});
			});
		};
		
		
		
		this._handleAjaxError = function(jqXHR, textStatus, errorThrown, context){
			console.log("ajax call error:" + errorThrown);
		};
		
		this._showCluster = function(data, context){
			
			var searchTerm = context._getQ(0);
			
			//@@@@Step 1: fill clusters
			if(data.clusters && data.clusters[0] && data.clusters[0].clusters){
				//1.1: set title
				var title = "Searches related to " + searchTerm;
				$("#" +  GSA_CLUSTER_title_ID).text(title);
				
				//1.2 fill items
				var clusters = data.clusters[0].clusters;
				$('#' + GSA_CLUSTER_TABLE1_ID).html('');
				$('#' + GSA_CLUSTER_TABLE2_ID).html('');
				for(var i = 0; i < clusters.length && i < 8; i++){
					var text = clusters[i].label;
					//sample <li><a href="#" class="gsa_update_search_link">tax <b>rate calculator</b></a>
					var row =  '<li><a href="#" ctype="cluster" class="' + GSA_UPDATE_SEARCH_LINK_CLASS + '" >' + text + '</a>'
					if(i < 4){
						$('#' + GSA_CLUSTER_TABLE1_ID).append(row);
					}else{
						$('#' + GSA_CLUSTER_TABLE2_ID).append(row);
					}
				}
			}else{
				$(".relatedSearches").each(function(){
					$(this).hide();
				});
			}
			
			//@@@@Step 2: bind search event for related search
			$("." + GSA_UPDATE_SEARCH_LINK_CLASS).each(function(){
				$(this).click(function(){
					var newSearchTerm = $(this).text();
					context._setQ(newSearchTerm);
					var eventType = ato.spa.config.getConfigValue('ato_search_event_cluster');
					context.setEventType(eventType);
					
					$("#" +  GSA_SEARCH_BUTTON_ID).click();
				});
			});
		};
		
		this.getCluster = function(q){
			var searchTerm = '';
			if(q){
				searchTerm = q;
			}else{
				searchTerm = this._getQ(0);
			}
			if(searchTerm == ''){
				return;
			}
			var params = this.requestParams;
			var url = ato.spa.search.getLastSearchURL();
			var paramsArray = url.split('&');
			for (var i = 0; i < paramsArray.length; i++) {
			    var oneParamArray = paramsArray[i].split('=');
			    params[oneParamArray[0]] = oneParamArray[1];
			}
			params.q = searchTerm;
			
			this._ajaxCall(ato.spa.gsa.services.cluster, params, this._showCluster);
		};
		
		this._parseSuggestData = function(item) {
			if (item.type == 'suggest') {
				
				var suggest = item.name.replace(/((nat|NAT|qc|QC)\s*[0-9]+)(\.)/g, "$1");
				return {
					label : suggest,
					value : suggest,
					display_type : 'text',
					type : 'suggest'
				};
			} else {
				var content = item.content;
				
				var url = item.moreDetailsUrl;
				url = ato.spa.gsa.trimWebappSuffix(url);
				var contentArray = content.split('#');
				var size = contentArray.length;
				var value = "";
				var description = "";
				var imageHtml = "";
				if(size == 2){ //only value#description
					value = contentArray[0];
					if(SHOW_UAR_DESCRIPTION){
						description = contentArray[1];
					}
				}else if(size == 3){//imageUrl#value#description
					imageHtml = ato.spa.util.htmlDecodeEscapeSequence(contentArray[0]);
					value = contentArray[1];
					if(SHOW_UAR_DESCRIPTION){
						description = contentArray[2];
					}
				}
				
				var labelHtml = "<a href='" + url + "' class='" + GSA_UAR_ITEM_LINK_CLASS + "'>" + imageHtml  + "&nbsp;" + value 
						+ "<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<p" + "' class='" + GSA_UAR_ITEM_DESC_CLASS + "'>" + description + "</p>"
						+ "</a>"; //may use template for it here..
				return {
					label : labelHtml,
					value : value,
					imageHtml : imageHtml,
					display_type : 'html',
					url : url,
					type : 'uar'
				};
			}
		};
		
		this.querySuggest = function(request, response,context) {   
			//@@@@Step 1: get the url for suggest
			var url = context._getSuggestURL() + "?client=" + context.requestParams.client + "&site=" + context.getSite() + "&max=10&format=rich";
			//to read the rich format which may contain UAR
			$.ajax({ 
				  url: url,        
				  dataType: "jsonp",        
				  type: 'GET',        
				  cache: true,        
				  jsonpCallback : "callbackMethod",        
				  data: {  q: request.term   },        
				  success: function (data) { 
					  if(data.results){
						 // response(data.results); //rich format
						  response($.map(data.results, context._parseSuggestData)); 
					  }else{
						  response($.map(data, function (item) { 
							  return {   label: item, value: item  }  
							  })); 
					  }//end if-else    
				  }//end success
					  
				});
			
		};
		
		// add event tracking..//ntptEventTag('ev=aaa&lc=bb') -- using 
		this.doSearch = function(parametersStr){
			var requestURL = this._getSearchService() + "?" + parametersStr;
			//append global parameters
			var q = ato.spa.gsa.getParameterByNameInURL('q',requestURL);
			
			//check if TFN is in it
			if(ato.spa.search.hasTFN(q)){
				this.showErrorMsg(ato.spa.search.messages.TFN_ERROR); 
				return false;
			}
			
			requestURL += "&" + ato.spa.search.buildGlobalParamsForURL(q,requestURL);
			requestURL = ato.spa.search.setGSAFilter(requestURL);
			this._ajaxCallSearch(requestURL); 
		};
		
		//do search directly, no TFN check, no parameters adding
		this.doSimpleSearch = function(parametersStr,successCallback,errorCallback){
			var url = this._getSearchService() + "?" + parametersStr;
			url = ato.spa.search.setGSAFilter(url);
			this._ajaxCall(ato.spa.gsa.services.search, url, successCallback,errorCallback);
		};
		
		this._ajaxCallSearch = function(url,successCallback,errorCallback){
			ato.spa.search.startHourGlass(ato.spa.search.stopHourGlass);
			this.setScrollPosition();
			this._ajaxCall(ato.spa.gsa.services.search, url, successCallback,errorCallback);
			this.changeHashForSearch(url);
		};
		
		this._ajaxCall = function(service,parameter,successCallback,errorCallback){
			var context = this;
			if(successCallback == undefined || successCallback == null){
				successCallback = this._showContent;
			}
			if(errorCallback == undefined || successCallback == null){
				errorCallback = this._handleAjaxError;
			}
			//to avoid jquery to add timestamp for script tag
			$.ajaxPrefilter('script', function(options) { options.cache = true; });
			
			var dataType = 'json';
			var requestType = 'GET';
			var url = '';
			var queryData = {};
			if(service == ato.spa.gsa.services.search){
				dataType = 'html';
				url =  ato.spa.search.appendGetfields(parameter);
				var numgm = ato.spa.gsa.getParameterByNameInURL('numgm',url);
				if(numgm == null || numgm == ''){
					url +=  "&numgm=" + ato.spa.config.getMaxKeyMatches();
				}
			}else if(service == ato.spa.gsa.services.cluster){
				dataType = 'json';
				requestType = 'POST';
				url = this._getClusterURL();
				queryData = parameter;
			}
			//-- check proxy
			if(url.indexOf(GSA_PORXY_DOMAIN) != 0){
				if(url.charAt(0) == '/'){
					url = GSA_PORXY_DOMAIN + url;
				}else{
					url = GSA_PORXY_DOMAIN + "/" + url;
				}
			}
			$.ajax({
				url:  url,
				dataType: dataType,
				type: requestType,
				data : queryData,
				success: function(data) {
					successCallback(data, context);
				},
				error:function(jqXHR, textStatus, errorThrown){
					errorCallback(jqXHR, textStatus, errorThrown, context);
				}
	  		});
		};
		
		this.UIUpdate = function(){
			//@@@@Step 1: do UI update for suggest
			$("ul.ui-autocomplete").each(function(){
				$(this).hide();
			});
			
			//@@@@Step 2: add GSA_SUGGEST_DIV_ID div
			var divStr = "<div id='" + GSA_SUGGEST_DIV_ID +"' style='display:block;position: absolute;z-index: 100000;background-color: white;'/>";
			if($(".searchBar").length == 0){
				$("body").append(divStr);
			}else{
				$($(".searchBar")[0]).append(divStr);
			}
			
			
		};
		
		this.initTopSearchBoxMobile = function(context){
			//@@@@Step 1: init suggestion:
			context._initSuggestMobile(context);
			
			//@@@@Step 2: init place holder
			context._initTopSearchBoxPlaceholder(context);
		};
		
		this.initLoad = function(){
			
			this.clearMsg();
			
			this.UIUpdate();
			
			//check if top search box exists
			//if there is search field, then bind eventhanlder to search box
			var topSearchField = ato.spa.search.getBannerSearchField ();
			if(ato.spa.search.isMobileView()){
				//mobile version
				//button event handler set.
				$('.' + GSA_TOP_SEARCH_MOBILE_BUTTON_CLASS).each(function(){
					$(this).click(function(){
						//delay  half a second to bind event handle after the popup is generated.
						setTimeout(function(){ato.spa.GSAManager.initTopSearchBoxMobile(ato.spa.GSAManager);},500);
					});
				});
				//set placeholder for main search field 
				var mainSearchField = $('#' + GSA_TOP_SEARCH_FIELD_ID);
				this._initSearchBoxPlaceholder(this,mainSearchField,true);
				//init suggestion for mobile
				this._initSuggestMobile(this);
				
			}else{
				if(topSearchField.length > 0){
					this._initTopSearchBox();
				}
			}
			
			if($("#" + GSA_PAGE_CONTAINER).length == 0){
				return;
			}
			this._initHashHandlerLink();
			var hashValue = location.hash;
			var forwardUrl = null;
			var searchRootPage = ato.spa.config.getSearchPage();
			if(hashValue != null && hashValue != ''){
				var temp = Base64.decode(ato.spa.gsa.cleanHashValue(hashValue));
				if(ato.spa.search.isSearchLoadUrl(temp)){
					forwardUrl = temp;
				}
			}
			if(hashValue == '' || forwardUrl != null){
				var url = this._getDefaultSearchURL(forwardUrl);
				// check if q is '' 
				var q = ato.spa.gsa.getParameterByNameInURL('q',url);
				var partialfields = ato.spa.gsa.getParameterByNameInURL('partialfields',url);
				var requiredfields = ato.spa.gsa.getParameterByNameInURL('requiredfields',url);

				if((q == null || q == '') && 
					(partialfields.indexOf(ato.spa.search.constants.DCTERMS_Identifier) < 0)
					&& (requiredfields.indexOf(ato.spa.search.constants.DCTERMS_Identifier) < 0)
					&& (partialfields.indexOf(ato.spa.search.constants.DCTERMS_NATNumber) < 0)
					&& (requiredfields.indexOf(ato.spa.search.constants.DCTERMS_NATNumber) < 0)){
					//remove requiredfields and partialfields to make sure no result
					url = ato.spa.gsa.replaceParamInURL(url,'requiredfields','' );
					url = ato.spa.gsa.replaceParamInURL(url,'partialfields','' );
				}
				//hot fix: to send QC NAT original query to GSA
				url = ato.spa.search.appendParamForBannerSearch(url);
				//default search -- load search page
				//ga tracking
				q = ato.spa.gsa.getParameterByNameInURL('q',url);
				if(ato.spa.gsa.ga){
					ato.spa.gsa.ga.triggerInitialSearch(q, false, url);
				}
				this._ajaxCallSearch(url);
			}else{
				//ga tracking
				var url = "?" + Base64.decode(ato.spa.gsa.cleanHashValue(hashValue));
				var q = ato.spa.gsa.getParameterByNameInURL('q', url);
				if(ato.spa.gsa.ga){
					ato.spa.gsa.ga.triggerInitialSearch(q , false, url);
				}

				this.loadSearchFromHash(hashValue);
			}
			
			
			//this.getCluster('test'); -- pass
		};
		
		this.getMSInTop = function(){
			var result = '';
			if($('#' + GSA_TOP_MS_CHK_ID).length > 0 && $('#' + GSA_TOP_MS_CHK_ID).attr('checked') == 'checked'){
				result = $('#' + GSA_TOP_MS_CHK_ID).val();
			}
			return result;
		};
		
		this._doTopSearch = function(){
			var url = ato.spa.config.getSearchPage();
			//get the top search field
			var topSearchField = ato.spa.search.getBannerSearchField();
	
			var q = topSearchField.val().trim();
			var defaultValue = ato.spa.config.getSearchPlaceholder();
			if(q == defaultValue){
				q = '';
			}
			
			//check if TFN is in it
			if(ato.spa.search.hasTFN(q)){
				this.showErrorMsg(ato.spa.search.messages.TFN_ERROR); 
				return false;
			}
			ato.spa.search.doBannerSearch(q);
		};
		
		this._initTopSearchBoxPlaceholder = function(context){
			//get the top search field
			var topSearchField = ato.spa.search.getBannerSearchField();
			context._initSearchBoxPlaceholder(context,topSearchField,true);
		};
		
		this._initMainSearchBoxPlaceholder = function(context){
			//get the search field
			var searchField = $(document.forms[0].q);
			var q = context._getQ(0);
			if(q == ''){
				context._initSearchBoxPlaceholder(context,searchField,true);
			}else{
				context._initSearchBoxPlaceholder(context,searchField,false);
			}
			
		};
		
		this._initSearchBoxPlaceholder = function(context, searchField,setDefaultValue){
			var defaultValue = ato.spa.config.getSearchPlaceholder();
			if(setDefaultValue){
				searchField.val(defaultValue);
			}
			
			searchField.focus(function () {
				var currentValue = $(this).val();
	            if(currentValue == defaultValue){
	            	searchField.val('');
	            }
		    }).keyup(function handler(event) {
	            var currentValue = $(this).val();
	            if(currentValue == defaultValue){
	            	searchField.val('');
	            }
	        }).blur(function () {
	        	var currentValue = $(this).val();
	            if (currentValue.length != 0) {
	                $(this).removeClass("inputBlurFilled");
	            }else{
	            	 $(this).val(defaultValue).addClass("inputBlurFilled");
	            }
	        });
		};
		

		
		this._initTopSearchBox = function(){
			//search button $("#txt_banner_field").siblings()
			var searchButton = $("." + GSA_TOP_SEARCH_BUTTON_CLASS)[0];
			this._initTopSearchBoxPlaceholder(this);
			
			$(searchButton).attr('onclick','').unbind('click');
			
			var topSearchField = ato.spa.search.getBannerSearchField();
			//unbind keypress event which may be bound in control.js
			setTimeout(function(){topSearchField.attr('onkeypress','').unbind('keypress');}, 200);
			
			$(searchButton).click(function(event){
				ato.spa.util.preventDefault(event);
				//do search
				return ato.spa.GSAManager._doTopSearch();
			});
			
			var searhForm = $("#" + GSA_TOP_FORM_ID);
			
			//show advanced search
			if(SHOW_ADVANCED_LINK){
				var checkboxDiv = $('#' + GSA_TOP_MS_CHK_ID).parent();
				this._showAdvanceLink(checkboxDiv);
			}
			//suggest for banner search
			if(window.QuerySuggest){
				window.QuerySuggest = querySuggest;
			}else{
				this._initSuggest(this);
			}
		};
		
		this._showAdvanceLink = function(obj){
			$(obj).after('<a class="spa_advance_link">Advanced Search</a>');
			var advancedURL = ato.spa.config.getConfigValue('advanced_page_url');
			$('.spa_advance_link').each(function(){
				$(this).attr("href", advancedURL);
			});
		};
		
		this._showSuggestItem = function(ul, item){
			//@@@@Step 1: set the title for suggest
//			if(ul.find("li").length == 0){
//				$( "<p class='"+ GSA_SUGGEST_HEAD_CLASS +"'>Popular Searches</p>" ).appendTo( ul);
//			}
			
			//@@@@Step 2: set title for UAR
			if(item.type == 'uar'){
				if(ul.find("." + GSA_UAR_HEAD_CLASS).length == 0){
					//$( "<p class='"+ GSA_UAR_HEAD_CLASS +"'>Suggested Results</p>" ).appendTo( ul);
					$('<li aria-hidden="true"><em id="shortcut-title" class="autocomplete-title ' + GSA_UAR_HEAD_CLASS + '">Take me straight to&hellip;</em></li>').appendTo( ul);
					
				}
			}
			var result = $( "<li>" );
			result.attr( "data-value", item.value );
			
			if(item.display_type == 'html'){ //UAR
				//<em id="shortcut-title" class="autocomplete-title" role="heading" aria-hidden="true">Take me straight to&hellip;</em>
			    //   <ul aria-labelledby="shortcut-title">
				//get UAR UL
				//var uarUL = $($("." + GSA_UAR_UL_CLASS)[0]);
				//result.remove();
//				 <li role="presentation" class="ui-menu-item">
//		          <a tabindex="-1" class="ui-corner-all" id="ui-id-6">
//		            <span class="glyphicon ato-icon-file" aria-hidden="true"></span>
//		            <span class="sr-only">Take me straight to:</span>
//		            teachers
//		          </a>
//		        </li>
				var htmlStr = '<a tabindex="-1" class="ui-corner-all" href="' + item.url + '">';
//				htmlStr += '<span class="glyphicon glyphicon-search" aria-hidden="true">' + item.imageHtml + '</span>';
				htmlStr += '<span class="glyphicon ato-icon-file" aria-hidden="true"></span>'  + item.imageHtml;
				htmlStr += '<span class="sr-only">Take me straight to:</span>';
				htmlStr += item.value;
				htmlStr += '</a>';
//				result.append( '<a tabindex="-1" class="ui-corner-all" >');
//				result.append('<span class="glyphicon glyphicon-search" aria-hidden="true">' + item.imageHtml + '</span>');
//				result.append('<span class="sr-only">Take me straight to:</span>');
//				result.append(item.value);
//				result.append('</a>');
				result.html(htmlStr);
				//result.appendTo(uarUL);
				
				//result.html(item.label);
			}else{//suggest
				//standard suggest
//				 <li role="presentation" class="ui-menu-item">
//		          <a tabindex="-1" class="ui-corner-all" id="ui-id-3">
//		            <span class="glyphicon glyphicon-search" aria-hidden="true"></span>
//		            termination payments
//		          </a>
//		        </li>
				var htmlStr = '<a tabindex="-1" class="ui-corner-all" >';
				htmlStr += '<span class="glyphicon glyphicon-search" aria-hidden="true"></span>';
				htmlStr += item.label;
				htmlStr += '</a>';
				result.html(htmlStr);
//				result.append( '<a tabindex="-1" class="ui-corner-all" >');
//				result.append('<span class="glyphicon glyphicon-search" aria-hidden="true"></span>');
//				result.append(item.label);
//				result.append("</a>");
			}
			result.appendTo( ul );
			return result;
		}//
		
		this._initSuggest = function(context){
			var eventType = ato.spa.config.getConfigValue('ato_search_event_suggest');
			var auto = $(".q").autocomplete({        
				  delay:300,        
				  source: function (request, response) { querySuggest(request, response);},        
				  messages: {noResults: '',results: function() {}},
				  minLength: 1,
				  _renderItem: context._showSuggestItem,
				  select:function(event, ui){
					  //add event track
					  var trackData = "ev=" + eventType + "&q="+ ui.item.value;
					  context.trackEvent(trackData);
					  //ga tracking
					  if(ato.spa.gsa.ga){
						  ato.spa.gsa.ga.triggerInitialSearch(ui.item.value, false);
					  }
					   $(".q").val(ui.item.value);
					  $("#" +  GSA_SEARCH_BUTTON_ID).click();
				  }
			});
			if(auto.data("ui-autocomplete")){
				auto.data("ui-autocomplete")._renderItem = context._showSuggestItem;
			}
			
			auto = $(".as_q").autocomplete({  
				  delay:300,        
				  source: function (request, response) { querySuggest(request, response);},         
				  minLength: 1,
				  select:function(event, ui){
					  //add event track 
					  var trackData = "ev=" + eventType + "&q=" + ui.item.value;
					  context.trackEvent(trackData);
					  //ga tracking
					  if(ato.spa.gsa.ga){
						  ato.spa.gsa.ga.triggerInitialSearch(ui.item.value, true);
					  }
					  $("#" +  GSA_SEARCH_BUTTON_ID).click();
				  }
			}); 
			
			if(auto.data("ui-autocomplete")){
				auto.data("ui-autocomplete")._renderItem = context._showSuggestItem;
			}
			  
			//for top search field
			var topSearchField = ato.spa.search.getBannerSearchField();
			auto = topSearchField.autocomplete({  
				  delay:300,        
				  source: function (request, response) { querySuggest(request, response);},         
				  minLength: 1,
				  select:function(event, ui){
					  //add event track
					  var trackData = "ev=" + eventType + "&q=" + ui.item.value;
					  context.trackEvent(trackData);
					  //ga tracking
					  //ato.spa.gsa.ga.triggerInitialSearch(ui.item.value, true);
					  topSearchField.val(ui.item.value);
					  context._doTopSearch();
				  }
			}); 
			
			
			if(auto.data("ui-autocomplete")){
				auto.data("ui-autocomplete")._renderItem = context._showSuggestItem;
			}
			 
			if($('#' + GSA_SUGGEST_DIV_ID).length > 0){
				$(".q").autocomplete( "option", "appendTo", "#"+GSA_SUGGEST_DIV_ID );
				topSearchField.autocomplete( "option", "appendTo", "#"+GSA_SUGGEST_DIV_ID );
				$(".as_q").autocomplete( "option", "appendTo", "#"+GSA_SUGGEST_DIV_ID );
			}
		};
		
		this._initSuggestMobile = function(context){
			var eventType = ato.spa.config.getConfigValue('ato_search_event_suggest');
			  
			//for top search field
			var topSearchField = ato.spa.search.getBannerSearchField();
			auto = topSearchField.autocomplete({  
				  delay:300,        
				  source: function (request, response) { querySuggest(request, response);},         
				  minLength: 1,
				  select:function(event, ui){
					  //add event track
					  var trackData = "ev=" + eventType + "&q=" + ui.item.value;
					  context.trackEvent(trackData);
					  //ga tracking
					  //ato.spa.gsa.ga.triggerInitialSearch(ui.item.value, true);
					  topSearchField.val(ui.item.value);
					  context._doTopSearch();
				  }
			}); 
			
			if(auto.data("ui-autocomplete")){
				auto.data("ui-autocomplete")._renderItem = context._showSuggestItem;
			}
			
			if($('#' + GSA_SUGGEST_DIV_ID).length > 0){
				topSearchField.autocomplete( "option", "appendTo", "#"+GSA_SUGGEST_DIV_ID );
			}
			
			//set z-index
			$('.ui-autocomplete').css('z-index', '5000');
		};
		
		this._initHashHandlerLink = function(){
			var tempArray = window.location.href.split("?");
			$.fn.hashchange.src = tempArray[0];
			$.fn.hashchange.domain = document.domain;
			var hash = location.hash;
			if($('#' +  GSA_HASH_LINK_ID).length == 0){
				$('body').append('<a href="#" id= "' + GSA_HASH_LINK_ID + '" style="display:none">gsa hash link</a>');
			}
			
			//set eventhandler
			$(window).hashchange(function(){
				var hashValue = location.hash;
				if($.browser.mozilla && (hashValue == null || hashValue == '')){
					history.go(-1);
				}
				if(hashValue != null && hashValue != ''){
					ato.spa.GSAManager.loadSearchFromHash(hashValue);
				}
				
			});
		};
		
		this.loadSearchFromHash = function(hashValue){
			if(this.doingSearch){
				this.doingSearch = false; //reset
				return;
			}
			this.loadingHistory = true;
			ato.spa.search.set_filter_from_hash = true;
			this.qResetNeeded = false;
			ato.spa.search.firstLoad = false;
			//decode 
			var url = Base64.decode(ato.spa.gsa.cleanHashValue(hashValue));
			ato.spa.search.resetSearchCacheForHistoryLoad();
			if(ato.spa.util.endWith(url, GSA_HASH_FLAG)){
				this._ajaxCallSearch(url);
			}
		};
		
		this.changeHashForSearch = function(searchURL){
			if(this.loadingHistory){
				this.loadingHistory = false;
				return;
			}
			var gsa_hash = ato.spa.gsa.getParameterByName('gsa_hash');
			var url = searchURL;
			if(gsa_hash == ''){
				url +=  GSA_HASH_FLAG;
			}
			//encode it.
			var hashValue = Base64.encode(url);
			this.doingSearch = true;
			
			
			$('#' +  GSA_HASH_LINK_ID).attr('href','#1');
			//$('#' +  GSA_HASH_LINK_ID).click();
			location.hash = hashValue;
		};
		
		this.setEventType = function(eventType){
			this._eventType = eventType;
		};
		
		this.getEventType = function(){
			return this._eventType;
		};
		
		this.trackEvent = function(data){
			this.setEventType('');
			if(window.ntptEventTag != undefined){
				ntptEventTag(data);
			}else{
				console.log("Event Tracking:" + data);
			}
		};
		
		this._handleErrorMessage = function(){
		  var messageDiv = '<div id="gsa_spa_msg_container_div" class="search_error" style="display:none"><div class="dangerLogo" title="Error"></div><div class="dangerMessage" id="gsa_spa_msg_div"></div></div>';
		  $("#gsa_spa_msg_container_div").hide();
		  if($("#gsa_spa_msg_container_div").length == 0){
			  $($(".searchBar")[0]).before(messageDiv);
		  }

		  //@@@@First case: empty search term
		  var q = this._getQ(0);
		  if(q == null || q.trim().length == 0){
			  var msg = ato.spa.config.getConfigValue('criteria_error_message');
			  $("#gsa_spa_msg_div").html(msg);
			  $("#gsa_spa_msg_container_div").show();
		  }
		};
	}
	ato.spa.GSAManager = new GSAManager();
})();

$(document).ready(function(){
	if(typeof ato.spa.gsa.ga  != 'undefined' && ato.spa.gsa.ga.init){
		ato.spa.gsa.ga.init(ato.spa.GSAManager);
	}
	ato.spa.search.initQueryForBannerSearch();
	ato.spa.GSAManager.initLoad();
});


